# 학습 스켈레톤 모음

이 문서는 CODEX.md의 3가지 핵심 이미지 태스크(캡셔닝, 탐지/카운팅, 이상탐지)에 대해 바로 실행/응용 가능한 최소 스켈레톤을 모았습니다. 각 스켈레톤은 환경 설치, 데이터 입출력, 모델 로딩, 추론 루틴, 핵심 하이퍼파라미터 위치를 포함합니다.

## 공통: 환경 준비

- Python 3.9+ 권장, CUDA 사용 시 PyTorch 버전은 GPU 환경에 맞춰 설치
- 가상환경(venv/conda) 권장

```bash
# 기본 공통 패키지
pip install torch torchvision timm transformers pillow

# 시각화/실험관리(선택)
pip install matplotlib opencv-python seaborn tensorboard wandb
```

---

## 1) 이미지 캡셔닝 (BLIP)

```python
# files: captioning_skeleton.py
from transformers import BlipProcessor, BlipForConditionalGeneration
from PIL import Image

MODEL_ID = "Salesforce/blip-image-captioning-base"  # base / large 등 변경 가능
MAX_NEW_TOKENS = 20                                  # 캡션 길이 상한

def load_model(model_id: str = MODEL_ID):
    processor = BlipProcessor.from_pretrained(model_id)
    model = BlipForConditionalGeneration.from_pretrained(model_id)
    model.eval()
    return processor, model

def generate_caption(image_path: str, max_new_tokens: int = MAX_NEW_TOKENS):
    processor, model = load_model()
    image = Image.open(image_path).convert("RGB")
    inputs = processor(image, return_tensors="pt")
    out = model.generate(**inputs, max_new_tokens=max_new_tokens)
    caption = processor.decode(out[0], skip_special_tokens=True)
    return caption

if __name__ == "__main__":
    print(generate_caption("sample.jpg"))
```

핵심 교체 지점
- `MODEL_ID`: `base`, `large`, `blip-2` 등으로 교체해 성능/지연시간 트레이드오프 조정
- `MAX_NEW_TOKENS`: 캡션 길이 조절로 표현력/중복 생성 균형 조정

---

## 2) 객체 탐지/카운팅 (YOLOv8)

```python
# files: detection_yolov8_skeleton.py
from ultralytics import YOLO

WEIGHTS = "yolov8n.pt"  # n/s/m/l/x 크기별 선택
CONF   = 0.25            # 신뢰도 임계값

def count_objects(image_path: str, class_names=None):
    model = YOLO(WEIGHTS)
    results = model(image_path, conf=CONF)
    # 단일 이미지 가정
    r = results[0]
    names = r.names
    counts = {}
    for box in r.boxes:
        cls_id = int(box.cls.item())
        name = names[cls_id]
        if (class_names is None) or (name in class_names):
            counts[name] = counts.get(name, 0) + 1
    return counts

if __name__ == "__main__":
    print(count_objects("image.jpg", class_names={"dog"}))
```

핵심 교체 지점
- `WEIGHTS`: 경량(n)→초고속, 대형(x)→정확도 우선
- `CONF`: 탐지 민감도 조절(낮출수록 더 많이 검출, 오검 증가 가능)
- `class_names`: 특정 클래스만 카운트하여 평가 집중

---

## 3) 텍스트 기반 탐지 (Grounding DINO)

```python
# files: detection_groundingdino_skeleton.py
from transformers import pipeline

MODEL_ID = "IDEA-Research/grounding-dino-base"

def detect_with_text(image_path: str, text: str):
    detector = pipeline(model=MODEL_ID)
    outputs = detector(text, images=image_path)
    # outputs: [{'scores': [...], 'labels': [...], 'boxes': [...]}]
    return outputs

if __name__ == "__main__":
    print(detect_with_text("image.jpg", text="dog"))
```

핵심 교체 지점
- `text` 프롬프트: “검출 의도”를 명확히 기술(복수 키워드, 한국어/영어 실험)
- 모델 스펙: `base`/`large` 변형, koCLIP 결합 등으로 한글 프롬프트 호환 개선

---

## 4) 이상/결함 탐지 (anomalib - PatchCore)

```python
# files: anomaly_patchcore_skeleton.py
from anomalib.models import Patchcore
from anomalib.data import MVTecAD

def run_patchcore(data_root: str = "data/", category: str = "bottle"):
    dataset = MVTecAD(root=data_root, category=category)
    model = Patchcore()
    model.fit(dataset)
    metrics = model.test(dataset)
    return metrics

if __name__ == "__main__":
    print(run_patchcore())
```

핵심 교체 지점
- `category`: `bottle`, `hazelnut`, `metal_nut` 등 대상 품목 변경
- PatchCore 파라미터: 백본, 메모리 뱅크 크기, 피처 레이어 선택에 따라 탐지력/속도 변화

---

## 5) 통합 추론 파이프라인 스켈레톤

```python
# files: pipeline_skeleton.py
"""단일 인터페이스로 캡셔닝/탐지/이상탐지를 선택 수행"""
from typing import Literal

Task = Literal["caption", "detect", "anomaly"]

def run(task: Task, **kwargs):
    if task == "caption":
        from captioning_skeleton import generate_caption
        return generate_caption(kwargs["image_path"], kwargs.get("max_new_tokens", 20))
    elif task == "detect":
        from detection_yolov8_skeleton import count_objects
        return count_objects(kwargs["image_path"], kwargs.get("class_names"))
    elif task == "anomaly":
        from anomaly_patchcore_skeleton import run_patchcore
        return run_patchcore(kwargs.get("data_root", "data/"), kwargs.get("category", "bottle"))
    else:
        raise ValueError("Unknown task")

if __name__ == "__main__":
    print(run("caption", image_path="sample.jpg"))
```

핵심 교체 지점
- 단일 진입점에 공통 로깅/시각화/타이밍 측정 추가
- CLI/웹UI(streamlit, gradio) 래핑으로 제출/데모용 확장

